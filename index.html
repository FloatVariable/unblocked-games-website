<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crimson Arcade</title>

<!-- SEO -->
<meta name="description" content="Dive into the shadows of gaming at Crimson Arcade. Play unblocked games with style and intensity." />
<meta name="keywords" content="crimson arcade, unblocked games, web games, browser games, dark gaming, arcade, free games" />
<link rel="canonical" href="https://example.com/" />
<meta property="og:title" content="Crimson Arcade" />
<meta property="og:description" content="Enter the dark realm of unlimited gaming" />
<meta property="og:type" content="website" />
<meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'%3E%3Crect width='100%25' height='100%25' fill='%23000000'/%3E%3Ctext x='50%25' y='52%25' dominant-baseline='middle' text-anchor='middle' fill='%23dc2626' font-size='64' font-family='Segoe UI, Roboto, Helvetica, Arial'%3ECrimson Arcade%3C/text%3E%3C/svg%3E" />
<meta name="color-scheme" content="dark" />

<style>
  :root{
    --bg: #0a0a0a; 
    --panel: #1a0a0a; 
    --panel-2: #250f0f; 
    --text: #ffffff; 
    --muted: #b89999;
    --accent: #dc2626; 
    --accent-2: #ef4444; 
    --accent-dark: #991b1b;
    --card: #141414; 
    --border: #2d1818;
    --shadow: 0 25px 50px rgba(220, 38, 38, 0.15);
    --glow: 0 0 20px rgba(220, 38, 38, 0.3);
    --radius: 16px;
  }
  
  *{
    box-sizing:border-box;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  html,body{height:100%}
  
  body{
    margin:0; 
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background: 
      radial-gradient(1400px 900px at 20% -10%, rgba(220, 38, 38, 0.08), transparent 70%),
      radial-gradient(1200px 800px at 80% 110%, rgba(239, 68, 68, 0.06), transparent 70%),
      linear-gradient(135deg, #0a0a0a 0%, #141414 50%, #0a0a0a 100%);
    color: var(--text);
    overflow-x: hidden;
    animation: backgroundPulse 8s ease-in-out infinite alternate;
  }
  
  @keyframes backgroundPulse {
    0% { background-size: 100% 100%, 100% 100%, 100% 100%; }
    100% { background-size: 110% 110%, 110% 110%, 100% 100%; }
  }

  .shell{
    max-width:1200px; 
    margin:0 auto; 
    padding:24px;
    animation: fadeInUp 0.8s ease-out;
  }
  
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  header{
    position:sticky; 
    top:0; 
    z-index:100; 
    backdrop-filter:saturate(1.2) blur(12px) brightness(0.8); 
    background: linear-gradient(135deg, rgba(10, 10, 10, 0.9), rgba(26, 10, 10, 0.8)); 
    border-bottom:2px solid var(--border);
    box-shadow: var(--shadow);
    animation: slideDown 0.6s ease-out;
  }
  
  @keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  .topbar{
    display:flex; 
    gap:16px; 
    align-items:center; 
    max-width:1200px; 
    margin:0 auto; 
    padding:16px 24px;
  }
  
  .brand{
    display:flex; 
    align-items:center; 
    gap:16px; 
    text-decoration:none; 
    color:inherit;
    transform: scale(1);
    transition: transform 0.3s ease, filter 0.3s ease;
  }
  
  .brand:hover{
    transform: scale(1.05);
    filter: drop-shadow(0 0 10px var(--accent));
  }
  
  .logo{
    width:42px; 
    height:42px; 
    border-radius:12px; 
    background: conic-gradient(from 45deg at 50% 50%, var(--accent), var(--accent-2), var(--accent-dark), var(--accent)); 
    box-shadow: var(--glow);
    position: relative;
    overflow: hidden;
    animation: logoSpin 3s linear infinite;
  }
  
  .logo::before {
    content: '';
    position: absolute;
    inset: 2px;
    border-radius: 10px;
    background: var(--panel);
    z-index: 1;
  }
  
  .logo::after {
    content: 'üéÆ';
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    z-index: 2;
  }
  
  @keyframes logoSpin {
    from { background-position: 0deg; }
    to { background-position: 360deg; }
  }
  
  h1{
    font-size:22px; 
    margin:0; 
    letter-spacing:0.5px;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
  }
  
  .grow{flex:1}
  
  .btn{
    appearance:none; 
    border:2px solid var(--border); 
    background:var(--panel); 
    color:var(--text); 
    padding:12px 18px; 
    border-radius:14px; 
    cursor:pointer; 
    font-weight:600; 
    position: relative;
    overflow: hidden;
    transform: translateY(0) scale(1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
    transform: translate(-50%, -50%);
    transition: all 0.4s ease;
    z-index: 0;
  }
  
  .btn:hover {
    transform: translateY(-3px) scale(1.05);
    border-color: var(--accent);
    box-shadow: var(--glow);
  }
  
  .btn:hover::before {
    width: 300px;
    height: 300px;
  }
  
  .btn:active {
    transform: translateY(-1px) scale(0.98);
  }
  
  .btn.primary{
    background: linear-gradient(135deg, var(--accent), var(--accent-2)); 
    color: white; 
    border-color: var(--accent);
    box-shadow: var(--glow);
  }
  
  .btn.ghost{
    background: var(--panel-2);
    border-color: var(--accent);
  }
  
  .pill{
    font-size:13px; 
    color:var(--muted); 
    border:1px solid var(--border); 
    background:var(--panel-2); 
    padding:8px 12px; 
    border-radius:999px;
    transition: all 0.3s ease;
  }
  
  .pill:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  
  .toggle{
    display:flex; 
    align-items:center; 
    gap:10px;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  
  .toggle:hover {
    transform: scale(1.05);
  }
  
  .toggle input{
    accent-color:var(--accent); 
    width:20px; 
    height:20px;
    cursor: pointer;
  }

  .alert{
    display:none; 
    place-items:center; 
    gap:12px; 
    border:2px solid var(--accent-dark); 
    background: linear-gradient(135deg, var(--panel), var(--panel-2)); 
    color:var(--accent-2); 
    padding:12px 16px; 
    border-radius:14px; 
    margin:16px 0;
    box-shadow: var(--glow);
    animation: alertSlide 0.5s ease-out;
  }
  
  @keyframes alertSlide {
    from { opacity: 0; transform: translateX(-100%); }
    to { opacity: 1; transform: translateX(0); }
  }
  
  .alert.show{display:grid}

  .searchbar{
    display:flex; 
    gap:12px; 
    align-items:center; 
    background:var(--panel); 
    padding:16px 18px; 
    border-radius:18px; 
    border:2px solid var(--border); 
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .searchbar::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(from 0deg, transparent, var(--accent), transparent);
    animation: searchGlow 3s linear infinite;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .searchbar:focus-within::before {
    opacity: 0.1;
  }
  
  @keyframes searchGlow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .searchbar:focus-within {
    border-color: var(--accent);
    box-shadow: var(--glow);
    transform: scale(1.02);
  }
  
  .searchbar input{
    flex:1; 
    background:transparent; 
    border:none; 
    outline:none; 
    color:var(--text); 
    font-size:16px;
    position: relative;
    z-index: 1;
  }
  
  .searchbar svg {
    position: relative;
    z-index: 1;
  }

  .grid{
    display:grid; 
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
    gap:20px; 
    margin-top:24px;
  }
  
  .card{
    background:var(--card); 
    border:2px solid var(--border); 
    border-radius:18px; 
    overflow:hidden; 
    display:flex; 
    flex-direction:column; 
    min-height:260px; 
    position:relative; 
    transform: translateY(0) scale(1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    animation: cardSlideIn 0.6s ease-out;
    animation-fill-mode: both;
  }
  
  .card:nth-child(odd) {
    animation-delay: 0.1s;
  }
  
  .card:nth-child(even) {
    animation-delay: 0.2s;
  }
  
  @keyframes cardSlideIn {
    from { opacity: 0; transform: translateY(50px) scale(0.9); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 1;
    border-radius: 16px;
  }
  
  .card:hover {
    transform: translateY(-8px) scale(1.03);
    box-shadow: 
      var(--glow),
      0 20px 40px rgba(0, 0, 0, 0.4);
    border-color: var(--accent);
  }
  
  .card:hover::before {
    opacity: 0.05;
  }
  
  .thumb{
    aspect-ratio:16/9; 
    background:linear-gradient(135deg, #1a1a1a, #0a0a0a); 
    display:block; 
    position:relative;
    overflow: hidden;
    border: none;
    cursor: pointer;
    z-index: 2;
  }
  
  .thumb::after {
    content: '‚ñ∂';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    color: white;
    font-size: 24px;
    background: rgba(220, 38, 38, 0.9);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 3;
  }
  
  .card:hover .thumb::after {
    transform: translate(-50%, -50%) scale(1);
  }
  
  .thumb img{
    width:100%; 
    height:100%; 
    object-fit:cover; 
    display:block;
    transition: transform 0.4s ease, filter 0.4s ease;
  }
  
  .card:hover .thumb img {
    transform: scale(1.1);
    filter: brightness(0.7);
  }
  
  .card-body{
    padding:16px; 
    display:flex; 
    gap:12px; 
    align-items:center;
    z-index: 2;
    position: relative;
  }
  
  .title{
    font-weight:700; 
    font-size:15px; 
    line-height:1.3; 
    flex:1;
    transition: color 0.3s ease;
  }
  
  .card:hover .title {
    color: var(--accent-2);
  }
  
  .fav{
    border:none; 
    background:transparent; 
    color:var(--muted); 
    cursor:pointer; 
    font-size:20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: scale(1);
  }
  
  .fav:hover {
    transform: scale(1.2) rotate(15deg);
    color: var(--accent-2);
    filter: drop-shadow(0 0 5px var(--accent));
  }
  
  .fav.active{
    color: gold;
    animation: favPulse 1.5s ease-in-out infinite;
  }
  
  @keyframes favPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  
  .empty{
    padding:48px; 
    text-align:center; 
    border:2px dashed var(--border); 
    border-radius:20px; 
    color:var(--muted); 
    background: linear-gradient(135deg, var(--panel-2), var(--panel));
    animation: emptyPulse 2s ease-in-out infinite alternate;
  }
  
  @keyframes emptyPulse {
    from { opacity: 0.7; }
    to { opacity: 1; }
  }
  
  .play-wrap{
    margin-top:24px; 
    display:flex; 
    flex-direction:column; 
    gap:16px;
    animation: fadeIn 0.8s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .frame-wrap{
    background:var(--panel); 
    border:2px solid var(--border); 
    border-radius:20px; 
    overflow:hidden; 
    box-shadow: var(--shadow);
    position: relative;
    animation: frameGlow 3s ease-in-out infinite alternate;
  }
  
  @keyframes frameGlow {
    from { box-shadow: var(--shadow); }
    to { box-shadow: var(--glow), var(--shadow); }
  }
  
  .frame-wrap iframe{
    display:block; 
    width:100%; 
    height:min(80vh, 900px); 
    background:#000;
    transition: opacity 0.5s ease;
  }
  
  .meta{
    display:flex; 
    gap:12px; 
    align-items:center; 
    flex-wrap:wrap;
  }
  
  .crumbs{
    color:var(--muted); 
    font-size:14px;
    transition: color 0.3s ease;
  }
  
  .crumbs a{
    color:inherit; 
    text-decoration:none;
    transition: all 0.3s ease;
  }
  
  .crumbs a:hover{
    color:var(--accent); 
    text-decoration:underline;
    text-shadow: 0 0 10px var(--accent);
  }

  .skeleton{
    background: linear-gradient(
      100deg, 
      color-mix(in oklab, var(--panel) 85%, #fff 0%), 
      color-mix(in oklab, var(--accent) 10%, var(--panel-2) 85%), 
      color-mix(in oklab, var(--panel) 85%, #fff 0%)
    ); 
    background-size: 200% 100%; 
    animation: skeletonPulse 1.5s linear infinite;
  }
  
  @keyframes skeletonPulse {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  
  @media (max-width:640px){
    .topbar{padding:12px 16px}
    .shell{padding:16px}
    .grid{grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:16px}
  }
  
  /* Loading animations */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.5s ease;
  }
  
  .loading-overlay.fade-out {
    opacity: 0;
    pointer-events: none;
  }
  
  .loader {
    width: 60px;
    height: 60px;
    border: 4px solid var(--border);
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    animation: loaderSpin 1s linear infinite;
  }
  
  @keyframes loaderSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: var(--bg);
  }
  
  ::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: var(--accent-2);
  }
</style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
  </div>

  <header>
    <div class="topbar" role="navigation" aria-label="Primary">
      <a href="#/" class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Crimson Arcade</h1>
      </a>
      <div class="grow"></div>
      <label class="toggle" title="Show favorites only">
        <input type="checkbox" id="filterFavs" />
        <span class="pill">Favorites</span>
      </label>
      <button class="btn ghost" id="refreshBtn" title="Reload games">‚ü≥ Reload</button>
      <a class="btn primary" href="#/">Browse</a>
    </div>
  </header>

  <main class="shell">
    <div id="alert" class="alert" role="status" aria-live="polite">‚ö†Ô∏è <span id="alertMsg">An error occurred.</span></div>

    <!-- Browse view -->
    <section id="homeView" hidden>
      <div class="searchbar" role="search">
        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M10 2a8 8 0 1 1 0 16c-1.85 0-3.55-.63-4.9-1.69L2.71 18.7a1 1 0 1 1-1.41-1.42l2.4-2.4A8 8 0 0 1 10 2m0 2a6 6 0 1 0 0 12A6 6 0 0 0 10 4"/></svg>
        <input id="searchInput" placeholder="Search games (name, tags)..." autocomplete="off" />
        <span id="countPill" class="pill">0 games</span>
      </div>
      <div id="grid" class="grid" aria-live="polite" aria-busy="true"></div>
      <div id="emptyState" class="empty" hidden>No results. Try another search.</div>
    </section>

    <!-- Play view -->
    <section id="playView" hidden>
      <nav class="meta">
        <div class="crumbs">‚Üê <a href="#/">Back to all games</a></div>
        <div class="grow"></div>
        <button id="fullscreenBtn" class="btn">‚õ∂ Fullscreen</button>
        <button id="favPlayBtn" class="btn">‚òÜ Favorite</button>
        <button id="manualLoadBtn" class="btn ghost" aria-controls="gameFrame">Load Game</button>
      </nav>
      <div class="play-wrap">
        <h2 id="playTitle" style="margin:6px 4px 4px 4px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></h2>
        <div class="frame-wrap">
          <iframe id="gameFrame" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" referrerpolicy="no-referrer" title="Game"></iframe>
        </div>
        <div id="frameNote" class="empty" hidden>
          If the game doesn't load here (embed blocked), use the fullscreen button.
        </div>
      </div>
    </section>
  </main>

  <footer style="text-align: center; padding: 20px; color: var(--muted); font-size: 14px;">
    ¬© 2025 Crimson Arcade ‚Ä¢ Unleash Your Gaming Spirit
  </footer>

<script>
(() => {
  // Hide loading overlay after page loads
  window.addEventListener('load', () => {
    setTimeout(() => {
      document.getElementById('loadingOverlay').classList.add('fade-out');
    }, 500);
  });

  // ==============================
  // Config
  // ==============================
  const DATA_URL = "https://raw.githubusercontent.com/FloatVariable/unblocked-games-website/main/games2.json";
  const LS_FAVS_KEY = "crimson.favorites.v3";

  const $ = sel => document.querySelector(sel);
  const els = {
    alert: $("#alert"), alertMsg: $("#alertMsg"),
    homeView: $("#homeView"), playView: $("#playView"),
    grid: $("#grid"), empty: $("#emptyState"),
    search: $("#searchInput"), count: $("#countPill"),
    filterFavs: $("#filterFavs"), refreshBtn: $("#refreshBtn"),
    playTitle: $("#playTitle"), gameFrame: $("#gameFrame"),
    frameNote: $("#frameNote"), manualLoadBtn: $("#manualLoadBtn"),
    favPlayBtn: $("#favPlayBtn"), fullscreenBtn: $("#fullscreenBtn"),
  };

  let ALL_GAMES = [];
  let FILTER = { q:"", favOnly:false };
  let iframeSrcPending = "";

  // ==============================
  // Helpers
  // ==============================
  const escapeHtml = (s="") => String(s).replace(/[&<>"'`=\/]/g, ch => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"
  }[ch]));

  const slugify = s => (s||"").toString().normalize("NFKD").replace(/[\u0300-\u036F]/g,'')
                    .replace(/[^a-zA-Z0-9]+/g, '-').replace(/(^-|-$)/g,'').toLowerCase();

  const debounce = (fn, ms=180) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  function showAlert(msg, sticky=false){
    els.alertMsg.textContent = msg;
    els.alert.classList.add("show");
    if (!sticky) setTimeout(()=> els.alert.classList.remove("show"), 4000);
  }

  // Convert common GitHub viewer/raw URLs to GitHub Pages URLs
  function normalizeGameUrl(u){
    if (!u) return "";
    let url = u.trim();

    if (!/^https?:\/\//i.test(url)) url = "https://" + url;

    try{
      const p = new URL(url);

      if (p.hostname === "github.com"){
        const parts = p.pathname.split("/").filter(Boolean);
        if (parts.length >= 5 && parts[2] === "blob"){
          const user = parts[0], repo = parts[1];
          const restPath = parts.slice(4).join("/");
          let pages = `https://${user}.github.io/${repo}/${restPath}`;
          if (!/\/[^\/.]+$/i.test(pages)) pages += "/";
          return pages;
        }
        if (parts.length >= 2){
          const user = parts[0], repo = parts[1];
          return `https://${user}.github.io/${repo}/`;
        }
      }

      if (p.hostname === "raw.githubusercontent.com"){
        const parts = p.pathname.split("/").filter(Boolean);
        if (parts.length >= 4){
          const user = parts[0], repo = parts[1];
          const restPath = parts.slice(3).join("/");
          let pages = `https://${user}.github.io/${repo}/${restPath}`;
          if (!/\/[^\/.]+$/i.test(pages)) pages += "/";
          return pages;
        }
      }

      if (/\.github\.io$/i.test(p.hostname)){
        if (!/\.[a-z0-9]+$/i.test(p.pathname) && !p.pathname.endsWith("/")){
          return p.origin + p.pathname + "/" + p.search + p.hash;
        }
      }

      return url;
    }catch{
      return url;
    }
  }

  // ==============================
  // Storage (with fallback)
  // ==============================
  function hasLocalStorage(){
    try{ const k="__ls_test__"+Date.now(); localStorage.setItem(k,"1"); localStorage.removeItem(k); return true; }
    catch{ return false; }
  }
  const SUPPORTS_LS = hasLocalStorage();
  const memoryFavs = new Set();

  function getFavs(){
    if (!SUPPORTS_LS) return new Set(memoryFavs);
    try { return new Set(JSON.parse(localStorage.getItem(LS_FAVS_KEY) || "[]")); }
    catch { return new Set(); }
  }
  function setFavs(set){
    if (!SUPPORTS_LS){ memoryFavs.clear(); for (const v of set) memoryFavs.add(v); return; }
    localStorage.setItem(LS_FAVS_KEY, JSON.stringify([...set]));
  }
  function toggleFav(slug){
    const favs = getFavs();
    favs.has(slug) ? favs.delete(slug) : favs.add(slug);
    setFavs(favs);
  }

  // ==============================
  // Networking
  // ==============================
  async function fetchWithTimeout(url, opts={}, ms=10000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    try{ return await fetch(url, {...opts, signal: ctrl.signal, cache:"no-store"}); }
    finally{ clearTimeout(t); }
  }
  async function robustFetchJson(url, {retries=2, timeout=12000} = {}){
    let lastErr;
    for (let attempt=0; attempt<=retries; attempt++){
      try{
        const res = await fetchWithTimeout(url, {}, timeout);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        return JSON.parse(text);
      }catch(err){
        lastErr = err; await new Promise(r => setTimeout(r, 300*(attempt+1)));
      }
    }
    throw lastErr || new Error("Unknown network error");
  }

  // ==============================
  // UI helpers
  // ==============================
  function skeletonCards(n=12){
    return Array.from({length:n}).map(()=>`
      <article class="card">
        <div class="thumb skeleton"></div>
        <div class="card-body">
          <div class="title skeleton" style="height:18px; width:75%"></div>
          <div class="pill skeleton" style="height:24px; width:65px"></div>
        </div>
      </article>
    `).join("");
  }
  function setBusy(b){ els.grid.setAttribute("aria-busy", b ? "true" : "false"); }

  // ==============================
  // Data load & normalization
  // ==============================
  async function fetchGames(){
    setBusy(true);
    els.grid.innerHTML = skeletonCards(12);
    try{
      const json = await robustFetchJson(DATA_URL);
      const rawList = Array.isArray(json) ? json
                    : Array.isArray(json?.games) ? json.games
                    : Object.values(json || {});
      ALL_GAMES = rawList.map((g,i)=>{
        const name = g.name || g.title || g.game_name || `Game ${i+1}`;
        const thumb = g.game_image_icon || g.thumbnail || g.image || "";
        const iframeUrl = typeof g.iframe === "string" ? g.iframe.trim() : "";
        const slug = g.slug || g["game-id"] || slugify(name);
        const tags = g.tags || g.category || g.categories || [];
        return {
          name, slug,
          thumb,
          iframe: normalizeGameUrl(iframeUrl),
          tags: Array.isArray(tags) ? tags : String(tags||"").split(/[,\s]+/).filter(Boolean),
        };
      }).filter(g => g.iframe);

      renderHome();
      if (!SUPPORTS_LS) showAlert("Local storage unavailable; favorites won't persist after reload.", true);
    }catch(err){
      console.error(err);
      els.grid.innerHTML = "";
      els.empty.hidden = false;
      showAlert("Couldn't load games. Check connection or try again.");
    }finally{
      setBusy(false);
    }
  }

  // ==============================
  // Home view
  // ==============================
  function Card(g, isFav){
    const thumbAttr = g.thumb ? `data-src="${escapeHtml(g.thumb)}"` : "";
    return `
      <article class="card" tabindex="0" aria-labelledby="t-${g.slug}">
        <button class="thumb" data-action="play" data-slug="${g.slug}" title="Play ${escapeHtml(g.name)}">
          ${g.thumb ? `<img loading="lazy" alt="${escapeHtml(g.name)} thumbnail" ${thumbAttr} />` : ""}
        </button>
        <div class="card-body">
          <div class="title" id="t-${g.slug}" title="${escapeHtml(g.name)}">${escapeHtml(g.name)}</div>
          <button class="fav ${isFav ? "active" : ""}" data-action="fav" data-slug="${g.slug}" aria-pressed="${isFav}" title="Toggle favorite">${isFav ? "‚òÖ" : "‚òÜ"}</button>
          <button class="btn" data-action="play" data-slug="${g.slug}" aria-label="Play ${escapeHtml(g.name)}">Play</button>
        </div>
      </article>
    `;
  }
  function renderHome(){
    showView("home");
    const favs = getFavs();
    const q = (FILTER.q||"").trim().toLowerCase();
    const list = ALL_GAMES.filter(g=>{
      const matchesQ = !q || g.name.toLowerCase().includes(q) || g.tags.some(t=> String(t).toLowerCase().includes(q));
      const matchesFav = !FILTER.favOnly || favs.has(g.slug);
      return matchesQ && matchesFav;
    });

    els.count.textContent = `${list.length} game${list.length===1?"":"s"}`;
    els.empty.hidden = list.length > 0;
    els.grid.innerHTML = list.map(g => Card(g, favs.has(g.slug))).join("");

    // wire actions
    [...els.grid.querySelectorAll('[data-action="play"]')].forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const slug = e.currentTarget.getAttribute("data-slug");
        location.hash = `#/play/${encodeURIComponent(slug)}`;
      });
    });
    [...els.grid.querySelectorAll('[data-action="fav"]')].forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const slug = e.currentTarget.getAttribute("data-slug");
        toggleFav(slug);
        
        // Add a small animation effect
        e.currentTarget.style.transform = 'scale(1.3) rotate(180deg)';
        setTimeout(() => {
          e.currentTarget.style.transform = '';
          renderHome();
        }, 300);
      });
    });

    startImageObserver();
  }

  // ==============================
  // Lazy loaders
  // ==============================
  let imgObserver;
  function startImageObserver(){
    if (imgObserver) imgObserver.disconnect();
    const imgs = els.grid.querySelectorAll("img[data-src]");
    if (!imgs.length) return;
    imgObserver = new IntersectionObserver((entries, obs)=>{
      entries.forEach(entry=>{
        if (entry.isIntersecting){
          const img = entry.target;
          img.src = img.dataset.src;
          img.removeAttribute("data-src");
          obs.unobserve(img);
          
          // Add fade-in effect when image loads
          img.addEventListener('load', () => {
            img.style.opacity = '0';
            img.style.transition = 'opacity 0.5s ease';
            setTimeout(() => img.style.opacity = '1', 50);
          });
        }
      });
    }, { rootMargin: "200px 0px" });
    imgs.forEach(img => imgObserver.observe(img));
  }

  let frameObserver;
  function startFrameObserver(){
    if (frameObserver) frameObserver.disconnect();
    frameObserver = new IntersectionObserver((entries, obs)=>{
      entries.forEach(e=>{
        if (e.isIntersecting && iframeSrcPending){
          els.gameFrame.src = iframeSrcPending;
          iframeSrcPending = "";
          obs.disconnect();
        }
      });
    }, { rootMargin: "0px 0px 200px 0px", threshold: 0.01 });
    frameObserver.observe(els.gameFrame);
  }

  // ==============================
  // Play view + Fullscreen
  // ==============================
  function renderPlay(slug){
    const game = ALL_GAMES.find(g => g.slug === slug);
    if (!game){ location.hash = "#/"; return; }

    showView("play");
    els.playTitle.textContent = game.name;

    const url = (game.iframe || "").trim();

    // Fullscreen: open about:blank, inject 100% iframe
    els.fullscreenBtn.onclick = ()=>{
      if (!url) return;
      const w = window.open("about:blank", "_blank");
      if (!w){ alert("Please allow popups for fullscreen."); return; }
      w.document.write(`<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>${escapeHtml(game.name)} - Crimson Arcade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;}
    iframe{border:0;width:100%;height:100%;}
  </style>
</head>
<body>
  <iframe src="${url}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" allowfullscreen referrerpolicy="no-referrer"></iframe>
</body>
</html>`);
      w.document.close();
    };

    // Favorite toggle
    const favs = getFavs();
    const favActive = favs.has(slug);
    els.favPlayBtn.textContent = favActive ? "‚òÖ Favorited" : "‚òÜ Favorite";
    els.favPlayBtn.setAttribute("aria-pressed", favActive ? "true" : "false");
    els.favPlayBtn.onclick = ()=>{
      toggleFav(slug);
      const active = getFavs().has(slug);
      els.favPlayBtn.textContent = active ? "‚òÖ Favorited" : "‚òÜ Favorite";
      els.favPlayBtn.setAttribute("aria-pressed", active ? "true" : "false");
      
      // Add visual feedback
      els.favPlayBtn.style.transform = 'scale(1.1)';
      setTimeout(() => els.favPlayBtn.style.transform = '', 200);
    };

    // Lazy-load the on-page iframe
    els.gameFrame.removeAttribute("src");
    iframeSrcPending = url;
    els.frameNote.hidden = true;

    els.manualLoadBtn.onclick = ()=>{
      if (iframeSrcPending){
        els.gameFrame.src = iframeSrcPending; 
        iframeSrcPending = "";
        els.manualLoadBtn.textContent = "Loading...";
        els.manualLoadBtn.disabled = true;
      }
    };

    startFrameObserver();

    // Show hint if embed is blocked and load doesn't fire quickly
    const t = setTimeout(()=>{ els.frameNote.hidden = false; }, 3500);
    els.gameFrame.addEventListener("load", ()=>{ 
      clearTimeout(t); 
      els.frameNote.hidden = true; 
      els.manualLoadBtn.textContent = "Load Game";
      els.manualLoadBtn.disabled = false;
    }, {once:true});
  }

  // ==============================
  // Router
  // ==============================
  function showView(which){
    const isHome = which === "home";
    els.homeView.hidden = !isHome;
    els.playView.hidden = isHome;
    if (isHome) els.search?.focus();
  }
  function parseHash(){
    const raw = location.hash || "#/";
    const parts = raw.split("/");
    if (parts[1] === "") return {route:"home"};
    if (parts[1] === "play" && parts[2]) return {route:"play", slug: decodeURIComponent(parts[2])};
    return {route:"home"};
  }
  function onRoute(){
    const r = parseHash();
    if (r.route === "home") renderHome();
    else if (r.route === "play") renderPlay(r.slug);
  }

  // ==============================
  // Enhanced interactions
  // ==============================
  
  // Add keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (location.hash.includes('/play/')) {
        location.hash = '#/';
      }
    }
    if (e.key === '/' && e.ctrlKey) {
      e.preventDefault();
      els.search?.focus();
    }
  });

  // Add mouse particle effect on card hover
  els.grid?.addEventListener('mousemove', (e) => {
    if (e.target.closest('.card')) {
      const card = e.target.closest('.card');
      const rect = card.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      card.style.setProperty('--mouse-x', x + '%');
      card.style.setProperty('--mouse-y', y + '%');
    }
  });

  // ==============================
  // Start
  // ==============================
  els.refreshBtn.addEventListener("click", () => {
    els.refreshBtn.textContent = "‚ü≥ Reloading...";
    els.refreshBtn.disabled = true;
    fetchGames().finally(() => {
      els.refreshBtn.textContent = "‚ü≥ Reload";
      els.refreshBtn.disabled = false;
    });
  });
  
  els.filterFavs.addEventListener("change", ()=>{ 
    FILTER.favOnly = !!els.filterFavs.checked; 
    renderHome();
    
    // Visual feedback for filter toggle
    els.filterFavs.parentElement.style.transform = 'scale(1.1)';
    setTimeout(() => els.filterFavs.parentElement.style.transform = '', 200);
  });
  
  els.search.addEventListener("input", debounce(()=>{ 
    FILTER.q = els.search.value || ""; 
    renderHome(); 
  }, 120));
  
  window.addEventListener("hashchange", onRoute);

  fetchGames().then(onRoute);
})();
</script>
</body>
</html>
